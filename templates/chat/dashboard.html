{% extends 'base.html' %}
{% load static %}

{% block title %}RAG Chat Assistant{% endblock %}

{% block content %}
<div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="rag-toggle-sidebar">
                <label class="toggle-switch">
                    <input type="checkbox" id="use-rag">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label">Use RAG (ground answers in PDFs when available)</span>
            </div>
            <button class="new-chat-btn" onclick="createNewChat()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="12" y1="18" x2="12" y2="12"></line>
                    <line x1="9" y1="15" x2="15" y2="15"></line>
                </svg>
                <span>New chat</span>
            </button>
        </div>
        
        <div class="sidebar-content">
            <div class="search-section">
                <div class="search-box">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                    <input type="text" placeholder="Search chats" id="chat-search">
                </div>
            </div>
            
            <div class="chats-section">
                <div class="section-header">
                    <span>Chats</span>
                </div>
                <div id="chat-list" class="chat-list">
                    {% for chat in chats %}
                    <div class="chat-item" data-chat-id="{{ chat.supabase_id }}" onclick="loadChat('{{ chat.supabase_id }}')">
                        <div class="chat-item-content">
                            <div class="chat-title">
                                <span class="title-text">{{ chat.title }}</span>
                            </div>
                            <div class="chat-actions">
                                <div class="dropdown">
                                    <button class="chat-action-btn" onclick="toggleDropdown(event)">
                                        <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                                            <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z" fill="currentColor"/>
                                        </svg>
                                    </button>
                                    <div class="dropdown-menu">
                                        <button class="dropdown-item" onclick="shareChat('{{ chat.supabase_id }}')">
                                            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                                                <path d="M13.5 2a1.5 1.5 0 0 1 1.5 1.5v9a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 12.5v-9A1.5 1.5 0 0 1 2.5 2h11zm0 1h-11a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5zM8 5.5a.5.5 0 0 1 .5.5v2.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 8.793V6a.5.5 0 0 1 .5-.5z" fill="currentColor"/>
                                            </svg>
                                            Share
                                        </button>
                                        <button class="dropdown-item" onclick="startRename(event, '{{ chat.supabase_id }}', '{{ chat.title }}')">
                                            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                                                <path d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 0 1-.927-.928l.929-3.25c.081-.286.235-.547.445-.758l8.61-8.61zm1.414 1.06a.25.25 0 0 0-.354 0L10.811 3.75l1.439 1.44 1.263-1.263a.25.25 0 0 0 0-.354L12.427 2.487zM11.189 6.25L9.75 4.81l-6.286 6.287a.25.25 0 0 0-.064.108l-.558 1.953 1.953-.558a.25.25 0 0 0 .108-.064l6.286-6.286z" fill="currentColor"/>
                                            </svg>
                                            Rename
                                        </button>
                                        <div class="menu-divider"></div>
                                        <button class="dropdown-item delete-item" onclick="deleteChat('{{ chat.supabase_id }}')">
                                            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                                                <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.251a.75.75 0 0 0 0 1.5h.365l-.318 6.15A1.5 1.5 0 0 0 3.705 12h8.59a1.5 1.5 0 0 0 1.407-1.85L13.384 4h.365a.75.75 0 0 0 0-1.5H11Zm-1.13 1.5.311 6h-6.362l.311-6h5.74ZM5.5 14a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-3H5.5v3Zm6-3v3a2.5 2.5 0 0 1-2.5 2.5h-3A2.5 2.5 0 0 1 3.5 14v-3h8Z" fill="currentColor"/>
                                            </svg>
                                            Delete
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% empty %}
                    <div class="empty-state">
                        <div class="empty-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                <path d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <p>No conversations yet</p>
                        <button class="new-chat-btn" onclick="createNewChat()">Start a new chat</button>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="sidebar-footer">
            <div class="user-profile" onclick="toggleLogoutButton()">
                <div class="user-avatar">
                    {% if user.is_authenticated %}
                        {{ user.username|first|upper }}
                    {% endif %}
                </div>
                <div class="user-info">
                    <div class="user-name">{{ user.username|default:"Guest" }}</div>
                    <div class="user-status">Online</div>
                </div>
            </div>
            <button class="logout-btn-sidebar" id="logout-btn-sidebar" onclick="event.stopPropagation(); logout()" title="Logout" style="display: none;">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M6 14H3a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h3M9 11l3-3-3-3M12 8H6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                Logout
            </button>
        </div>
    </div>
    
    <!-- Main Chat Area -->
    <div class="main-content">
        <div class="chat-header">
            <button id="sidebar-toggle-btn" class="menu-toggle" title="Toggle sidebar">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="3" y1="6" x2="21" y2="6"></line>
                    <line x1="3" y1="12" x2="21" y2="12"></line>
                    <line x1="3" y1="18" x2="21" y2="18"></line>
                </svg>
            </button>
            <div class="chat-title-section">
                <h1 id="chat-title">RAG Chat Assistant</h1>
            </div>
        </div>
        
        <div class="chat-content">
            <!-- Uploaded PDFs Section with Drag & Drop -->
            <div id="uploaded-pdfs" class="upload-pdf-container" style="display: none;">
                <p class="upload-pdf-label">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="margin-right: 8px;">
                        <path d="M13.5 0h-11A1.5 1.5 0 0 0 1 1.5v13A1.5 1.5 0 0 0 2.5 16h11a1.5 1.5 0 0 0 1.5-1.5v-13A1.5 1.5 0 0 0 13.5 0zM3 4h10v1H3V4zm0 3h10v1H3V7zm0 3h7v1H3v-1z" fill="currentColor"/>
                    </svg>
                    Upload PDF(s)
                </p>
                <div class="drag-drop-area" id="drag-drop-area">
                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2ZM12 4C16.4183 4 20 7.58172 20 12C20 16.4183 16.4183 20 12 20C7.58172 20 4 16.4183 4 12C4 7.58172 7.58172 4 12 4ZM11 10V7H13V10H16L12 14L8 10H11Z" fill="#3b82f6"/>
                    </svg>
                    <div class="drag-drop-content">
                        <p class="drag-drop-text">Drag and drop files here</p>
                        <p class="drag-drop-limit">Limit 200MB per file • PDF</p>
                    </div>
                    <button class="browse-files-btn" onclick="document.getElementById('pdf-upload-input').click()">Browse files</button>
                    <input type="file" id="pdf-upload-input" accept=".pdf" multiple style="display: none;">
                </div>
                
                <!-- Dynamically added uploaded files will go here -->
                <div id="uploaded-files-list"></div>

                <!-- PDF Upload Success Message -->
                <div id="pdf-upload-success" class="pdf-upload-success-message" style="display: none;">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M8 1C4.13401 1 1 4.13401 1 8C1 11.866 4.13401 15 8 15C11.866 15 15 11.866 15 8C15 4.13401 11.866 1 8 1ZM7.00001 11.5L4.5 9L5.5 8L7.00001 9.5L10.5 6L11.5 7L7.00001 11.5Z" fill="#166534"/>
                    </svg>
                    <span>PDF uploaded successfully</span>
                </div>
            </div>
            
            <div id="chat-messages" class="messages-container">
                <div class="welcome-message" id="welcome-screen">
                    <h1 class="main-title">Good to see you, {{ user.username|default:"there" }}.</h1>
                    <p class="main-subtitle">How can I help you today?</p>
                    
                    <div class="welcome-icon">
                        <svg width="64" height="64" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="createNewChat()">
                            Start New Chat
                        </button>
                        <button class="quick-action-btn" onclick="uploadPDF()" id="welcome-upload-btn">
                            <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                                <path d="M14 2H2a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1zM1 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V3z" fill="currentColor"/>
                                <path d="M5 6h6M5 8h6M5 10h4" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                            </svg>
                            Upload PDF
                        </button>
                        <button class="quick-action-btn" onclick="askQuestion('What is the main topic of the uploaded document?')">
                            Summarize Document
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="input-container">
                <div class="input-wrapper">
                    <input type="text" id="message-input" placeholder="Message RAG Chat Assistant..." disabled>
                    <button class="send-btn" id="send-btn" onclick="sendMessage()" disabled>
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 8l-2.147 2.146a.5.5 0 0 0 .708.708l3-3zM0.5 8.5H15v-1H0.5v1z" fill="currentColor"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- PDF Viewer Modal -->
<div class="pdf-modal" id="pdfViewerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000;">
    <div class="pdf-modal-content" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; width: 80%; max-width: 800px; max-height: 80%; overflow: hidden;">
        <div class="pdf-modal-header" style="padding: 16px 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="color: var(--text-primary); margin: 0;">PDF Viewer</h3>
            <button onclick="closePDFModal()" style="background: none; border: none; color: var(--text-primary); font-size: 24px; cursor: pointer;">&times;</button>
        </div>
        <div class="pdf-modal-body" style="padding: 20px; max-height: 60vh; overflow-y: auto;">
            <div id="pdf-content">
                <p style="color: var(--text-muted);">Loading PDF content...</p>
            </div>
        </div>
    </div>
</div>

<script>
let currentChatId = null;


function createNewChat() {
    const csrfToken = getCookie('csrftoken');
    console.log('CSRF Token:', csrfToken);
    
    return fetch('/api/chat/create/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            title: 'New Chat'
        })
    })
    .then(response => {
        console.log('Create chat response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Create chat response data:', data);
        console.log('Response keys:', Object.keys(data));
        console.log('Has error field:', 'error' in data);
        console.log('Error value:', data.error);
        
        if (data.error) {
            console.error('Error creating chat:', data.error);
            alert('Error creating chat: ' + data.error);
            throw new Error(data.error);
        } else {
            console.log('Chat created successfully, loading...');
            console.log('Chat ID to load:', data.id);
            // Hide welcome screen
            const welcomeScreen = document.getElementById('welcome-screen');
            if (welcomeScreen) {
                welcomeScreen.style.display = 'none';
            }
            // Add chat to sidebar
            addChatToSidebar(data.id, data.title || 'New Chat');
            // Load the new chat
            loadChat(data.id);
            return data;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating chat');
        throw error;
    });
}

    function addChatToSidebar(chatId, title) {
        const chatList = document.getElementById('chat-list');
        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.setAttribute('data-chat-id', chatId);
        chatItem.onclick = () => loadChat(chatId);
        
        chatItem.innerHTML = `
            <div class="chat-item-content">
                <div class="chat-title">
                    <span class="title-text">${title}</span>
                </div>
                <div class="chat-actions">
                    <div class="dropdown">
                        <button class="chat-action-btn" onclick="event.stopPropagation(); toggleDropdown(event)">
                            <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                                <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z" fill="currentColor"/>
                            </svg>
                        </button>
                        <div class="dropdown-menu">
                            <button class="dropdown-item" onclick="shareChat('${chatId}')">
                                <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                                    <path d="M13.5 2a1.5 1.5 0 0 1 1.5 1.5v9a1.5 1.5 0 0 1-1.5 1.5h-11A1.5 1.5 0 0 1 1 12.5v-9A1.5 1.5 0 0 1 2.5 2h11zm0 1h-11a.5.5 0 0 0-.5.5v9a.5.5 0 0 0 .5.5h11a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5zM8 5.5a.5.5 0 0 1 .5.5v2.793l1.146-1.147a.5.5 0 0 1 .708.708l-2 2a.5.5 0 0 1-.708 0l-2-2a.5.5 0 1 1 .708-.708L7.5 8.793V6a.5.5 0 0 1 .5-.5z" fill="currentColor"/>
                                </svg>
                                Share
                            </button>
                            <button class="dropdown-item" onclick="startRename(event, '${chatId}', '${title}')">
                                <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                                    <path d="M11.013 1.427a1.75 1.75 0 0 1 2.474 0l1.086 1.086a1.75 1.75 0 0 1 0 2.474l-8.61 8.61c-.21.21-.47.364-.756.445l-3.251.93a.75.75 0 0 1-.927-.928l.929-3.25c.081-.286.235-.547.445-.758l8.61-8.61zm1.414 1.06a.25.25 0 0 0-.354 0L10.811 3.75l1.439 1.44 1.263-1.263a.25.25 0 0 0 0-.354L12.427 2.487zM11.189 6.25L9.75 4.81l-6.286 6.287a.25.25 0 0 0-.064.108l-.558 1.953 1.953-.558a.25.25 0 0 0 .108-.064l6.286-6.286z" fill="currentColor"/>
                                </svg>
                                Rename
                            </button>
                            <div class="menu-divider"></div>
                            <button class="dropdown-item delete-item" onclick="deleteChat('${chatId}')">
                                <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                                    <path d="M6.5 1h3a.5.5 0 0 1 .5.5v1H6v-1a.5.5 0 0 1 .5-.5ZM11 2.5v-1A1.5 1.5 0 0 0 9.5 0h-3A1.5 1.5 0 0 0 5 1.5v1H2.251a.75.75 0 0 0 0 1.5h.365l-.318 6.15A1.5 1.5 0 0 0 3.705 12h8.59a1.5 1.5 0 0 0 1.407-1.85L13.384 4h.365a.75.75 0 0 0 0-1.5H11Zm-1.13 1.5.311 6h-6.362l.311-6h5.74ZM5.5 14a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-3H5.5v3Zm6-3v3a2.5 2.5 0 0 1-2.5 2.5h-3A2.5 2.5 0 0 1 3.5 14v-3h8Z" fill="currentColor"/>
                                </svg>
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Insert at the beginning of the chat list
        if (chatList.querySelector('.empty-state')) {
            chatList.innerHTML = '';
        }
        chatList.insertBefore(chatItem, chatList.firstChild);
    }

    function loadChat(chatId) {
        console.log('Loading chat:', chatId);
        currentChatId = chatId;
        document.getElementById('chat-title').textContent = 'RAG Chat Assistant';
        document.getElementById('message-input').disabled = false;
        document.getElementById('send-btn').disabled = false;
        // Hide welcome screen
        const welcomeScreen = document.getElementById('welcome-screen');
        if (welcomeScreen) {
            welcomeScreen.style.display = 'none';
        }
        
        // Add class to indicate chat is active
        document.body.classList.add('chat-active');
        
        // Show PDF upload section only if RAG is enabled
        const ragCheckbox = document.getElementById('use-rag');
        if (ragCheckbox.checked) {
            document.getElementById('uploaded-pdfs').style.display = 'block';
        } else {
            document.getElementById('uploaded-pdfs').style.display = 'none';
        }
    
    // Load messages
    fetch(`/api/chat/${chatId}/messages/`)
    .then(response => response.json())
    .then(messages => {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.innerHTML = '';
        console.log('Loading messages for chat:', chatId, 'Found:', messages.length, 'messages');
        if (messages.length === 0) {
            // Show welcome UI for new empty chat
            chatMessages.innerHTML = `
                <div class="new-chat-welcome">
                    <h1 class="new-chat-title">What are you working on?</h1>
                </div>
            `;
            // Update input placeholder for new chat
            document.getElementById('message-input').placeholder = 'Ask anything';
            // Add class to body for styling
            document.body.classList.add('new-chat-empty');
        } else {
            // Update input placeholder for existing chat
            document.getElementById('message-input').placeholder = 'Message RAG Chat Assistant...';
            // Remove new-chat-empty class to restore normal input positioning
            document.body.classList.remove('new-chat-empty');
            console.log('Displaying messages:', messages);
            messages.forEach(message => {
                addMessageToChat(message.role, message.content, message.sources);
            });
        }
    })
    .catch(error => {
        console.error('Error loading messages:', error);
    });
    
    // Load uploaded PDFs
    loadUploadedPDFs(chatId);
}

function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    if (!message || !currentChatId) return;
    
    // Add user message to chat
    addMessageToChat('user', message);
    input.value = '';
    
    // Show loading indicator
    const loadingDiv = document.createElement('div');
    loadingDiv.className = 'message assistant';
    loadingDiv.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Thinking...';
    document.getElementById('chat-messages').appendChild(loadingDiv);
    
    // Send to backend
    fetch('/api/chat/send-message/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
            chat_id: currentChatId,
            message: message,
            use_rag: document.getElementById('use-rag').checked
        })
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading indicator
        const loadingDiv = document.querySelector('.message.assistant:last-child');
        if (loadingDiv && loadingDiv.innerHTML.includes('spinner')) {
            loadingDiv.remove();
        }
        
        if (data.error) {
            addMessageToChat('assistant', 'Error: ' + data.error);
        } else {
            addMessageToChat('assistant', data.response, data.sources);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        addMessageToChat('assistant', 'Error: Failed to get response');
    });
}

function addMessageToChat(role, content, sources = []) {
    console.log('Adding message to chat:', role, content.substring(0, 50) + '...');
    const chatMessages = document.getElementById('chat-messages');
    
    // Remove new chat welcome message if present
    const newChatWelcome = chatMessages.querySelector('.new-chat-welcome');
    if (newChatWelcome) {
        newChatWelcome.remove();
        // Update placeholder when first message is sent
        document.getElementById('message-input').placeholder = 'Message RAG Chat Assistant...';
        // Remove class from body
        document.body.classList.remove('new-chat-empty');
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${role} mb-3`;
    
    // Format content with better styling
    const formattedContent = formatMessageContent(content);
    
    // Sources display removed
    let sourcesHtml = '';
    
    messageDiv.innerHTML = `
        <div class="message-meta">${role.charAt(0).toUpperCase() + role.slice(1)}</div>
        <div class="message-bubble">
            <div class="message-content">${formattedContent}</div>
        </div>
    `;
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

function formatMessageContent(content) {
    let formatted = content;
    
    // Convert markdown tables to HTML tables
    // Match tables with pipe separators and separator rows
    const tableRegex = /(\|[^\n]*\|(?:\n\|[:\s\-|]+\|)?(?:\n\|[^\n]*\|)+)/gm;
    
    formatted = formatted.replace(tableRegex, (match) => {
        try {
            const lines = match.trim().split('\n').filter(line => line.trim() && line.includes('|'));
            if (lines.length < 1) return match;
            
            // Find separator row (usually contains dashes or colons)
            let separatorIndex = -1;
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                // Check if line is a separator (contains mostly dashes, colons, or pipes with minimal text)
                if (line.match(/^\|[\s:|\-]+$/)) {
                    separatorIndex = i;
                    break;
                }
            }
            
            // First line is header (or first non-separator line)
            const headerRow = separatorIndex > 0 ? lines[0] : lines[0];
            // Data rows start after separator (or after header if no separator)
            const dataRows = separatorIndex > 0 ? lines.slice(separatorIndex + 1) : lines.slice(1);
            
            // Parse header
            const headers = headerRow.split('|')
                .map(h => h.trim())
                .filter(h => h && !h.match(/^:?-+:?$/));
            
            if (headers.length === 0) return match;
            
            let html = '<div class="markdown-table-wrapper" style="overflow-x: auto; margin: 16px 0;"><table class="markdown-table" style="width: 100%; border-collapse: collapse; background-color: transparent;"><thead><tr>';
            headers.forEach(header => {
                html += `<th style="padding: 8px 12px; text-align: left; border-bottom: 1px solid var(--border-color); color: var(--text-primary); font-weight: 600;">${header}</th>`;
            });
            html += '</tr></thead><tbody>';
            
            // Parse data rows
            dataRows.forEach(row => {
                const cells = row.split('|')
                    .map(c => c.trim())
                    .filter((c, index, arr) => {
                        if (index === 0 && c === '') return false;
                        if (index === arr.length - 1 && c === '') return false;
                        return true;
                    });
                
                if (cells.length > 0) {
                    html += '<tr>';
                    for (let i = 0; i < headers.length; i++) {
                        html += `<td style="padding: 8px 12px; border-bottom: 1px solid var(--border-color); color: var(--text-primary);">${cells[i] || ''}</td>`;
                    }
                    html += '</tr>';
                }
            });
            
            html += '</tbody></table></div>';
            return html;
        } catch (e) {
            console.error('Error parsing table:', e);
            return match;
        }
    });
    
    // Convert markdown-style formatting to HTML
    formatted = formatted
        // Horizontal rules (---)
        .replace(/^---+\s*$/gm, '<hr style="border: none; border-top: 1px solid var(--border-color); margin: 16px 0;">')
        // Bold text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        // Italic text
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        // Headers (all levels including #### and #####)
        .replace(/^##### (.*$)/gm, '<h6>$1</h6>')
        .replace(/^#### (.*$)/gm, '<h6>$1</h6>')
        .replace(/^### (.*$)/gm, '<h5>$1</h5>')
        .replace(/^## (.*$)/gm, '<h4>$1</h4>')
        .replace(/^# (.*$)/gm, '<h3>$1</h3>')
        // Bullet points
        .replace(/^• (.*$)/gm, '<li class="mb-1">$1</li>')
        .replace(/^- (.*$)/gm, '<li class="mb-1">$1</li>')
        // Numbered lists
        .replace(/^(\d+)\. (.*$)/gm, '<li class="mb-1"><strong>$1.</strong> $2</li>');
    
    // Wrap lists in ul tags
    formatted = formatted.replace(/(<li class="mb-1">.*<\/li>)/gs, '<ul class="list-unstyled ms-3">$1</ul>');
    
    // Handle line breaks (but preserve table HTML)
    formatted = formatted.split(/\n\n+/).map(para => {
        // Don't process if it's already HTML (like tables)
        if (para.trim().startsWith('<') || para.includes('<table>') || para.includes('<div class="markdown-table-wrapper">')) {
            return para;
        }
        return para.replace(/\n/g, '<br>');
    }).join('<br><br>');
    
    return formatted;
}

// Enter key handler
document.getElementById('message-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

function uploadPDF() {
    if (!currentChatId) {
        // Enable RAG mode first
        const ragCheckbox = document.getElementById('use-rag');
        if (ragCheckbox) {
            ragCheckbox.checked = true;
        }
        
        // Create a new chat first
        createNewChat().then((newChat) => {
            // Ensure RAG mode is still enabled after chat creation
            const ragCheckbox = document.getElementById('use-rag');
            if (ragCheckbox) {
                ragCheckbox.checked = true;
            }
            
            // Wait a moment for the chat to be loaded, then trigger upload
            setTimeout(() => {
                if (currentChatId) {
                    // Trigger the file input
                    uploadPDF();
                }
            }, 1000);
        }).catch(error => {
            console.error('Error creating chat:', error);
            alert('Error creating new chat');
        });
        return;
    }
    
    // Ensure RAG mode is enabled
    const ragCheckbox = document.getElementById('use-rag');
    if (ragCheckbox && !ragCheckbox.checked) {
        ragCheckbox.checked = true;
    }
    
    // Create file input
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.pdf';
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.name.toLowerCase().endsWith('.pdf')) {
            alert('Please select a PDF file');
            return;
        }
        
        // Show upload progress - removed button reference since it no longer exists
        
        // Upload file
        const formData = new FormData();
        formData.append('file', file);
        formData.append('csrfmiddlewaretoken', getCookie('csrftoken'));
        
        fetch(`/documents/upload/${currentChatId}/`, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Reload PDFs after successful upload
                loadUploadedPDFs(currentChatId);
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Upload error:', error);
            alert('Upload failed: ' + error.message);
        })
        .finally(() => {
            uploadBtn.disabled = false;
            uploadBtn.innerHTML = originalText;
        });
    };
    
    input.click();
}

function loadUploadedPDFs(chatId) {
    if (!chatId) return;
    
    console.log('Loading PDFs for chat:', chatId);
    
    fetch(`/documents/api/chat/${chatId}/documents/`)
    .then(response => {
        console.log('PDF API response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(documents => {
        console.log('PDFs loaded:', documents);
        const pdfList = document.getElementById('pdf-list');
        if (documents.length === 0) {
            pdfList.innerHTML = '<p class="text-muted mb-0">No documents uploaded yet.</p>';
        } else {
            let html = '';
                documents.forEach(doc => {
                    const uploadDate = new Date(doc.created_at).toLocaleDateString();
                    html += `
                        <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <div>
                                <i class="fas fa-file-pdf text-danger me-2"></i>
                                <strong>${doc.filename}</strong>
                                <br>
                                <small class="text-muted">Uploaded: ${uploadDate}</small>
                            </div>
                            <div class="btn-group" role="group">
                                <button class="btn btn-outline-primary btn-sm" onclick="viewPDF('${doc.id}')">
                                    <i class="fas fa-eye me-1"></i>View
                                </button>
                                <button class="btn btn-outline-danger btn-sm" onclick="deletePDF('${doc.id}', '${doc.filename}')">
                                    <i class="fas fa-trash me-1"></i>Delete
                                </button>
                            </div>
                        </div>
                    `;
                });
            pdfList.innerHTML = html;
        }
    })
    .catch(error => {
        console.error('Error loading PDFs:', error);
        document.getElementById('pdf-list').innerHTML = `<p class="text-danger mb-0">Error loading documents: ${error.message}</p>`;
    });
}

    function viewPDF(documentId) {
        // Show modal
        document.getElementById('pdfViewerModal').style.display = 'block';
        
        // Load PDF content
        document.getElementById('pdf-content').innerHTML = '<p style="color: var(--text-muted);">Loading PDF content...</p>';
        
        // Fetch PDF chunks and display them
        fetch(`/documents/api/view/${documentId}/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let content = '<div class="pdf-text-content">';
                data.chunks.forEach((chunk, index) => {
                    content += `
                        <div style="margin-bottom: 16px; padding: 12px; border: 1px solid var(--border-color); border-radius: 6px; background: var(--bg-tertiary);">
                            <h6 style="color: var(--text-primary); margin-bottom: 8px;">Page ${chunk.page_number}</h6>
                            <p style="color: var(--text-secondary); margin: 0; line-height: 1.5;">${chunk.content}</p>
                        </div>
                    `;
                });
                content += '</div>';
                document.getElementById('pdf-content').innerHTML = content;
            } else {
                document.getElementById('pdf-content').innerHTML = '<p style="color: #ef4444;">Error loading PDF content: ' + data.error + '</p>';
            }
        })
        .catch(error => {
            console.error('Error loading PDF:', error);
            document.getElementById('pdf-content').innerHTML = '<p style="color: #ef4444;">Error loading PDF content.</p>';
        });
    }

    function closePDFModal() {
        document.getElementById('pdfViewerModal').style.display = 'none';
    }

    function toggleLogoutButton() {
        const logoutBtn = document.getElementById('logout-btn-sidebar');
        if (logoutBtn) {
            const isVisible = logoutBtn.style.display !== 'none';
            logoutBtn.style.display = isVisible ? 'none' : 'block';
        }
    }

    function logout() {
        const userEmail = '{{ user.email|default:user.username }}';
        showLogoutModal(userEmail, () => {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/accounts/logout/';
            const csrfToken = getCookie('csrftoken');
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrfToken;
            form.appendChild(csrfInput);
            document.body.appendChild(form);
            form.submit();
        });
    }

    // Logout confirmation modal (ChatGPT-style)
    function showLogoutModal(userEmail, onOk) {
        let modal = document.getElementById('logout-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'logout-modal';
            modal.innerHTML = `
            <div class="logout-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:10000;">
              <div class="logout-card" style="background:#2d2d2d;border:1px solid #404040;color:#ffffff;border-radius:12px;min-width:320px;max-width:90vw;width:400px;box-shadow:0 12px 28px rgba(0,0,0,0.5);padding:24px;">
                <div style="margin-bottom:16px;">
                  <div style="font-size:18px;font-weight:600;color:#ffffff;margin-bottom:8px;">Are you sure you want to log out?</div>
                  <div style="font-size:14px;font-weight:400;color:#e0e0e0;line-height:1.5;">Log out of ChatGPT as ${userEmail}?</div>
                </div>
                <div style="display:flex;flex-direction:column;gap:10px;">
                  <button type="button" id="logout-confirm" style="background:#ffffff;border:1px solid #4a9eff;color:#2d2d2d;padding:10px 16px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;width:100%;transition:opacity 0.2s;">Log out</button>
                  <button type="button" id="logout-cancel" style="background:#3a3a3a;border:1px solid #404040;color:#ffffff;padding:10px 16px;border-radius:20px;cursor:pointer;font-size:14px;font-weight:500;width:100%;transition:background-color 0.2s;">Cancel</button>
                </div>
              </div>
            </div>`;
            document.body.appendChild(modal);
            
            // Add hover effects
            const confirmBtn = modal.querySelector('#logout-confirm');
            const cancelBtn = modal.querySelector('#logout-cancel');
            confirmBtn.addEventListener('mouseenter', () => { confirmBtn.style.opacity = '0.9'; });
            confirmBtn.addEventListener('mouseleave', () => { confirmBtn.style.opacity = '1'; });
            cancelBtn.addEventListener('mouseenter', () => { cancelBtn.style.background = '#404040'; });
            cancelBtn.addEventListener('mouseleave', () => { cancelBtn.style.background = '#3a3a3a'; });
        } else {
            modal.querySelector('.logout-card > div:first-child > div:last-child').textContent = `Log out of ChatGPT as ${userEmail}?`;
            modal.style.display = 'flex';
        }
        
        const close = () => { 
            modal.style.display = 'none';
        };
        
        const backdrop = modal.querySelector('.logout-backdrop');
        backdrop.onclick = (e) => {
            if (e.target === backdrop) {
                close();
            }
        };
        
        modal.querySelector('#logout-cancel').onclick = close;
        modal.querySelector('#logout-confirm').onclick = () => { 
            close(); 
            onOk && onOk(); 
        };
    }

    // Reusable confirm modal
    function showConfirmModal(message, onOk) {
        let modal = document.getElementById('confirm-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'confirm-modal';
            modal.innerHTML = `
            <div class="confirm-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:flex-start;justify-content:center;padding:20px 20px 0;z-index:10000;">
              <div class="confirm-card" style="background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--text-primary);border-radius:12px;min-width:320px;max-width:90vw;box-shadow:0 12px 28px rgba(0,0,0,0.35); margin-left: 220px;">
                <div style="padding:16px 20px;border-bottom:1px solid var(--border-color);font-weight:600;">Confirm</div>
                <div class="confirm-message" style="padding:16px 20px;">${message}</div>
                <div style="display:flex;gap:12px;justify-content:flex-end;padding:12px 16px;border-top:1px solid var(--border-color);">
                  <button type="button" id="confirm-cancel" style="background:transparent;border:1px solid var(--border-color);color:var(--text-primary);padding:8px 14px;border-radius:8px;cursor:pointer;">Cancel</button>
                  <button type="button" id="confirm-ok" style="background:var(--accent-primary);border:1px solid var(--accent-primary);color:#fff;padding:8px 14px;border-radius:8px;cursor:pointer;">OK</button>
                </div>
              </div>
            </div>`;
            document.body.appendChild(modal);
        } else {
            modal.querySelector('.confirm-message').textContent = message;
            modal.style.display = 'flex';
        }
        const close = () => { modal.style.display = 'none'; };
        modal.querySelector('#confirm-cancel').onclick = close;
        modal.querySelector('#confirm-ok').onclick = () => { close(); onOk && onOk(); };
    }

    function deletePDF(documentId, filename) {
        console.log('Delete PDF requested for:', documentId, filename);
        if (confirm(`Are you sure you want to delete "${filename}"? This action cannot be undone.`)) {
            console.log('User confirmed PDF deletion');
            
            // Show loading state
            const deleteBtn = event.target.closest('button');
            const originalText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Deleting...';
            
            // Make API call to delete document
            fetch(`/documents/api/delete/${documentId}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                console.log('Delete PDF response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Delete PDF response data:', data);
                if (data.success) {
                    console.log('PDF deleted successfully');
                    // Reload PDFs list
                    loadUploadedPDFs(currentChatId);
                    // Show success message
                    alert(data.message);
                } else {
                    console.error('Delete PDF failed:', data.error);
                    alert('Error deleting PDF: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error deleting PDF:', error);
                alert('Error deleting PDF: ' + error.message);
            })
            .finally(() => {
                // Restore button state
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalText;
            });
        } else {
            console.log('User cancelled PDF deletion');
        }
    }

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Sidebar toggle logic (mobile + desktop)
    (function initSidebarToggle(){
        const sidebar = document.getElementById('sidebar');
        const toggleBtn = document.getElementById('sidebar-toggle-btn');
        if (!sidebar || !toggleBtn) return;

        let backdrop = document.getElementById('sidebar-backdrop');
        if (!backdrop) {
            backdrop = document.createElement('div');
            backdrop.className = 'sidebar-backdrop';
            backdrop.id = 'sidebar-backdrop';
            document.body.appendChild(backdrop);
        }

        function isMobile(){ return window.innerWidth <= 1024; }

        function openMobile(){
            sidebar.classList.add('open');
            backdrop.classList.add('show');
            document.body.style.overflow = 'hidden';
        }
        function closeMobile(){
            sidebar.classList.remove('open');
            backdrop.classList.remove('show');
            document.body.style.overflow = '';
        }
        function toggle(){
            if (isMobile()) {
                if (sidebar.classList.contains('open')) closeMobile(); else openMobile();
            } else {
                sidebar.classList.toggle('desktop-collapsed');
            }
        }

        toggleBtn.addEventListener('click', toggle);
        backdrop.addEventListener('click', closeMobile);
        window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeMobile(); });
        window.addEventListener('resize', ()=>{ if (!isMobile()) closeMobile(); });
    })();

    function closeAllDropdowns() {
        document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
            menu.classList.remove('show');
        });
    }

    function toggleDropdown(event) {
        event.stopPropagation();
        const dropdown = event.target.closest('.dropdown');
        const menu = dropdown.querySelector('.dropdown-menu');
        
        // Close all other dropdowns
        document.querySelectorAll('.dropdown-menu.show').forEach(openMenu => {
            if (openMenu !== menu) {
                openMenu.classList.remove('show');
            }
        });
        
        // Toggle current dropdown
        menu.classList.toggle('show');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(event) {
        if (!event.target.closest('.dropdown')) {
            document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
        }
    });

    function loadUploadedPDFs(chatId) {
        fetch(`/documents/api/chat/${chatId}/documents/`)
        .then(response => response.json())
        .then(documents => {
            console.log('Loaded PDFs:', documents);
            const pdfList = document.getElementById('pdf-list');
            if (documents.length === 0) {
                pdfList.innerHTML = '<p class="empty-pdfs">No documents uploaded yet.</p>';
            } else {
                let html = '';
                documents.forEach(doc => {
                    const uploadDate = new Date(doc.created_at).toLocaleDateString();
                    html += `
                        <div class="pdf-item">
                            <div class="pdf-info">
                                <svg class="pdf-icon" width="20" height="20" viewBox="0 0 16 16" fill="none">
                                    <path d="M14 2H2a1 1 0 0 0-1 1v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V3a1 1 0 0 0-1-1zM1 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V3z" fill="currentColor"/>
                                    <path d="M5 6h6M5 8h6M5 10h4" stroke="currentColor" stroke-width="1" stroke-linecap="round"/>
                                </svg>
                                <div class="pdf-details">
                                    <h4>${doc.filename}</h4>
                                    <p>Uploaded: ${uploadDate}</p>
                                </div>
                            </div>
                            <div class="pdf-actions">
                                <button class="pdf-action-btn" onclick="viewPDF('${doc.id}')">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                                        <path d="M8 1C4.5 1 1.73 3.11 1 6c.73 2.89 3.5 5 7 5s6.27-2.11 7-5c-.73-2.89-3.5-5-7-5zM8 9.5a3.5 3.5 0 1 1 0-7 3.5 3.5 0 0 1 0 7z" fill="currentColor"/>
                                    </svg>
                                    View
                                </button>
                                <button class="pdf-action-btn delete-btn" onclick="deletePDF('${doc.id}', '${doc.filename}')">
                                    <svg width="14" height="14" viewBox="0 0 16 16" fill="none">
                                        <path d="M2 4h12M5.333 4V2.667a1.333 1.333 0 0 1 1.334-1.334h2.666a1.333 1.333 0 0 1 1.334 1.334V4M6.667 7.333v4M9.333 7.333v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                    Delete
                                </button>
                            </div>
                        </div>
                    `;
                });
                pdfList.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error loading PDFs:', error);
            document.getElementById('pdf-list').innerHTML = `<p class="empty-pdfs" style="color: #ef4444;">Error loading documents: ${error.message}</p>`;
        });
    }

    // Quick action functions
    function askQuestion(question) {
        if (!currentChatId) {
            alert('Please select a chat first');
            return;
        }
        
        document.getElementById('message-input').value = question;
        sendMessage();
    }

    function startRename(event, chatId, currentTitle) {
        event.stopPropagation(); // Prevent chat selection
        
        // Find the chat item and title elements
        const chatItem = event.target.closest('.chat-item');
        const titleElement = chatItem.querySelector('.chat-title');
        const titleText = titleElement.querySelector('.title-text');
        
        // Create input field
        const input = document.createElement('input');
        input.type = 'text';
        input.value = currentTitle;
        input.className = 'rename-input';
        input.style.cssText = `
            background: var(--bg-primary);
            border: 1px solid var(--accent-primary);
            color: var(--text-primary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            width: 100%;
            outline: none;
        `;
        
        // Replace title text with input
        titleText.style.display = 'none';
        titleElement.appendChild(input);
        
        // Focus and select text
        input.focus();
        input.select();
        
        // Handle save on Enter or blur
        const saveRename = () => {
            const newName = input.value.trim();
            if (newName && newName !== currentTitle) {
                // Make API call to rename chat
                fetch(`/api/chat/${chatId}/rename/`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ title: newName })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        titleText.textContent = newName;
                        console.log('Chat renamed successfully');
                    } else {
                        alert('Error renaming chat: ' + data.error);
                        titleText.textContent = currentTitle; // Revert on error
                    }
                })
                .catch(error => {
                    console.error('Error renaming chat:', error);
                    alert('Error renaming chat');
                    titleText.textContent = currentTitle; // Revert on error
                });
            }
            
            // Restore original display
            titleText.style.display = 'inline';
            input.remove();
        };
        
        const cancelRename = () => {
            titleText.style.display = 'inline';
            input.remove();
        };
        
        input.addEventListener('blur', saveRename);
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                saveRename();
            } else if (e.key === 'Escape') {
                e.preventDefault();
                cancelRename();
            }
        });
    }

    function shareChat(chatId) {
        console.log('shareChat called with ID:', chatId);
        
        // Close any open dropdowns
        closeAllDropdowns();
        
        // Get chat title
        const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
        const chatTitle = chatItem ? chatItem.querySelector('.title-text').textContent : 'Chat';
        
        // Create share URL
        const shareUrl = `${window.location.origin}/chat/${chatId}`;
        
        // Fetch messages for preview
        fetch(`/api/chat/${chatId}/messages/`)
            .then(response => response.json())
            .then(messages => {
                showShareModal(chatTitle, messages, shareUrl);
            })
            .catch(error => {
                console.error('Error loading messages for share:', error);
                // Show modal with just title if messages fail to load
                showShareModal(chatTitle, [], shareUrl);
            });
    }
    
    // Share modal (ChatGPT-style)
    function showShareModal(chatTitle, messages, shareUrl) {
        // Escape HTML to prevent XSS
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
        
        // Get sample messages for preview
        let userMessage = '';
        let assistantMessage = '';
        
        if (messages && messages.length > 0) {
            // Find first user message
            const firstUserMsg = messages.find(m => m.role === 'user');
            if (firstUserMsg) {
                userMessage = escapeHtml(firstUserMsg.content.substring(0, 100)); // Truncate to 100 chars
                if (firstUserMsg.content.length > 100) userMessage += '...';
            }
            
            // Find first assistant message
            const firstAssistantMsg = messages.find(m => m.role === 'assistant');
            if (firstAssistantMsg) {
                assistantMessage = escapeHtml(firstAssistantMsg.content.substring(0, 200)); // Truncate to 200 chars
                if (firstAssistantMsg.content.length > 200) assistantMessage += '...';
            }
        }
        
        const escapedTitle = escapeHtml(chatTitle);
        const escapedUrl = escapeHtml(shareUrl);
        
        let modal = document.getElementById('share-modal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'share-modal';
            document.body.appendChild(modal);
        }
        
        modal.innerHTML = `
            <div class="share-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:10000;" onclick="event.target === event.currentTarget && closeShareModal()">
              <div class="share-card" style="background:#1e1e1e;border:1px solid #404040;color:#ffffff;border-radius:12px;min-width:400px;max-width:90vw;width:600px;max-height:90vh;overflow-y:auto;box-shadow:0 12px 28px rgba(0,0,0,0.5);">
                <!-- Header -->
                <div style="position:relative;padding:20px 24px;border-bottom:1px solid #404040;display:flex;align-items:center;justify-content:center;">
                  <h2 style="margin:0;font-size:20px;font-weight:600;color:#ffffff;">${escapedTitle}</h2>
                  <button onclick="closeShareModal()" style="position:absolute;right:24px;top:50%;transform:translateY(-50%);background:transparent;border:1px solid #ffffff;border-radius:50%;width:32px;height:32px;color:#ffffff;cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                      <line x1="18" y1="6" x2="6" y2="18"></line>
                      <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                  </button>
                </div>
                
                <!-- Chat Preview -->
                <div style="background:#2d2d2d;padding:24px;margin:16px;border-radius:8px;min-height:200px;">
                  ${userMessage ? `
                    <div style="margin-bottom:16px;text-align:right;">
                      <div style="color:#ffffff;font-size:14px;line-height:1.6;margin-bottom:4px;">${userMessage}</div>
                    </div>
                  ` : ''}
                  ${assistantMessage ? `
                    <div style="margin-bottom:16px;text-align:left;">
                      <div style="color:#ffffff;font-size:14px;line-height:1.6;margin-bottom:4px;">${assistantMessage}</div>
                    </div>
                  ` : '<div style="color:#888;font-size:14px;text-align:center;padding:40px 0;">No messages to preview</div>'}
                  <div style="text-align:right;margin-top:16px;">
                    <span style="font-size:16px;font-weight:600;color:#ffffff;">RAG Chat Assistant</span>
                  </div>
                </div>
                
                <!-- Footer - Share Options -->
                <div style="border-top:1px solid #404040;padding:20px 24px;">
                  <div style="display:flex;justify-content:center;align-items:center;gap:32px;">
                    <button onclick="copyShareLink(event, '${escapedUrl.replace(/'/g, "\\'")}')" style="background:transparent;border:none;color:#ffffff;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:8px;padding:8px;border-radius:8px;transition:background-color 0.2s;">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path>
                        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path>
                      </svg>
                      <span style="font-size:12px;color:#888;">Copy link</span>
                    </button>
                    <button onclick="shareToLinkedIn('${escapedUrl.replace(/'/g, "\\'")}', '${escapedTitle.replace(/'/g, "\\'")}')" style="background:transparent;border:none;color:#ffffff;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:8px;padding:8px;border-radius:8px;transition:background-color 0.2s;">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                      </svg>
                      <span style="font-size:12px;color:#888;">LinkedIn</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>`;
        
        modal.style.display = 'flex';
        
        // Add hover effects to share buttons
        const shareButtons = modal.querySelectorAll('.share-card button');
        shareButtons.forEach(btn => {
            btn.addEventListener('mouseenter', () => { btn.style.backgroundColor = '#333'; });
            btn.addEventListener('mouseleave', () => { btn.style.backgroundColor = 'transparent'; });
        });
    }
    
    function closeShareModal() {
        const modal = document.getElementById('share-modal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    function copyShareLink(event, url) {
        // Try modern clipboard API first
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(url).then(() => {
                // Show success message
                const btn = event.target.closest('button');
                if (btn) {
                    const span = btn.querySelector('span');
                    if (span) {
                        const originalText = span.textContent;
                        span.textContent = 'Copied!';
                        span.style.color = '#4a9eff';
                        setTimeout(() => {
                            span.textContent = originalText;
                            span.style.color = '#888';
                        }, 2000);
                    }
                }
            }).catch(() => {
                // Fallback to selection method
                fallbackCopyText(url, event);
            });
        } else {
            // Fallback to selection method
            fallbackCopyText(url, event);
        }
    }
    
    function fallbackCopyText(text, event) {
        // Create temporary input element
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        textArea.style.top = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            const successful = document.execCommand('copy');
            if (successful) {
                // Show success message
                const btn = event.target.closest('button');
                if (btn) {
                    const span = btn.querySelector('span');
                    if (span) {
                        const originalText = span.textContent;
                        span.textContent = 'Copied!';
                        span.style.color = '#4a9eff';
                        setTimeout(() => {
                            span.textContent = originalText;
                            span.style.color = '#888';
                        }, 2000);
                    }
                }
            } else {
                // Show URL in a friendly modal instead of alert
                showCopyFallbackModal(text);
            }
        } catch (err) {
            // Show URL in a friendly modal instead of alert
            showCopyFallbackModal(text);
        } finally {
            document.body.removeChild(textArea);
        }
    }
    
    function showCopyFallbackModal(url) {
        // Close share modal first
        closeShareModal();
        
        // Escape HTML
        const escapeHtml = (text) => {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        };
        
        const escapedUrl = escapeHtml(url);
        
        // Show a friendly modal with the URL
        const modal = document.createElement('div');
        modal.id = 'copy-fallback-modal';
        modal.innerHTML = `
            <div class="copy-backdrop" style="position:fixed;inset:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:10001;">
              <div class="copy-card" style="background:#1e1e1e;border:1px solid #404040;color:#ffffff;border-radius:12px;min-width:320px;max-width:90vw;width:500px;box-shadow:0 12px 28px rgba(0,0,0,0.5);padding:24px;">
                <h3 style="margin:0 0 16px 0;font-size:18px;font-weight:600;color:#ffffff;">Copy Link</h3>
                <p style="margin:0 0 16px 0;font-size:14px;color:#e0e0e0;line-height:1.5;">Please copy the link below:</p>
                <div style="background:#2d2d2d;border:1px solid #404040;border-radius:8px;padding:12px;margin-bottom:16px;">
                  <input type="text" id="url-to-copy" value="${escapedUrl}" readonly style="width:100%;background:transparent;border:none;color:#ffffff;font-size:14px;outline:none;cursor:pointer;" onclick="this.select();">
                </div>
                <div style="display:flex;justify-content:flex-end;gap:12px;">
                  <button onclick="document.getElementById('copy-fallback-modal').remove();" style="background:#3a3a3a;border:1px solid #404040;color:#ffffff;padding:8px 16px;border-radius:8px;cursor:pointer;font-size:14px;font-weight:500;">Close</button>
                </div>
              </div>
            </div>`;
        document.body.appendChild(modal);
        
        // Auto-select the URL
        setTimeout(() => {
            const urlInput = document.getElementById('url-to-copy');
            if (urlInput) {
                urlInput.select();
            }
        }, 100);
        
        // Close on backdrop click
        modal.querySelector('.copy-backdrop').onclick = (e) => {
            if (e.target === e.currentTarget) {
                modal.remove();
            }
        };
    }
    
    function shareToX(url, title) {
        const text = encodeURIComponent(`${title} - ${url}`);
        window.open(`https://twitter.com/intent/tweet?text=${text}`, '_blank', 'width=550,height=420');
    }
    
    function shareToLinkedIn(url, title) {
        const encodedUrl = encodeURIComponent(url);
        window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodedUrl}`, '_blank', 'width=550,height=420');
    }
    
    function shareToReddit(url, title) {
        const text = encodeURIComponent(title);
        const encodedUrl = encodeURIComponent(url);
        window.open(`https://reddit.com/submit?title=${text}&url=${encodedUrl}`, '_blank', 'width=550,height=420');
    }

    function deleteChat(chatId) {
        console.log('Delete chat requested for:', chatId);
        if (confirm('Are you sure you want to delete this chat? This action cannot be undone.')) {
            console.log('User confirmed deletion');
            // Make API call to delete chat
            fetch(`/api/chat/${chatId}/delete/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                }
            })
            .then(response => {
                console.log('Delete response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Delete response data:', data);
                if (data.success) {
                    console.log('Chat deleted successfully');
                    // Remove chat item from UI
                    const chatItem = document.querySelector(`[data-chat-id="${chatId}"]`);
                    console.log('Found chat item:', chatItem);
                    if (chatItem) {
                        chatItem.remove();
                        console.log('Removed chat item from UI');
                    }
                    
                    // If this was the current chat, redirect to dashboard
                    if (currentChatId === chatId) {
                        console.log('Redirecting to dashboard after deleting current chat');
                        // Redirect to dashboard/home page
                        window.location.href = '/chat/';
                    }
                } else {
                    console.error('Delete failed:', data.error);
                    alert('Error deleting chat: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error deleting chat:', error);
                alert('Error deleting chat: ' + error.message);
            });
        } else {
            console.log('User cancelled deletion');
        }
    }

    // Search functionality
    function searchChats(query) {
        console.log('Searching for:', query);
        const chatItems = document.querySelectorAll('.chat-item');
        console.log('Found chat items:', chatItems.length);
        const searchQuery = query.toLowerCase().trim();
        
        let visibleCount = 0;
        
        chatItems.forEach(item => {
            const titleElement = item.querySelector('.title-text');
            const title = titleElement ? titleElement.textContent.toLowerCase() : '';
            console.log('Checking title:', title, 'against query:', searchQuery);
            
            if (searchQuery === '' || title.includes(searchQuery)) {
                item.style.display = 'block';
                visibleCount++;
            } else {
                item.style.display = 'none';
            }
        });
        
        console.log('Visible chats:', visibleCount);
        
        // Show/hide "No chats found" message
        const chatList = document.getElementById('chat-list');
        
        if (searchQuery !== '' && visibleCount === 0) {
            // Show no results message
            let noResultsMsg = chatList.querySelector('.no-results');
            if (!noResultsMsg) {
                noResultsMsg = document.createElement('div');
                noResultsMsg.className = 'no-results';
                noResultsMsg.style.cssText = `
                    padding: 20px;
                    text-align: center;
                    color: var(--text-muted);
                    font-style: italic;
                `;
                noResultsMsg.textContent = 'No chats found matching your search';
                chatList.appendChild(noResultsMsg);
            }
            noResultsMsg.style.display = 'block';
        } else {
            // Hide no results message
            const noResultsMsg = chatList.querySelector('.no-results');
            if (noResultsMsg) {
                noResultsMsg.style.display = 'none';
            }
        }
    }

    // Enhanced chat item click handler
    document.addEventListener('DOMContentLoaded', function() {
        const chatItems = document.querySelectorAll('.chat-item');
        chatItems.forEach(item => {
            item.addEventListener('click', function(e) {
                // Don't trigger if clicking on dropdown
                if (e.target.closest('.dropdown')) return;
                
                const chatId = this.dataset.chatId;
                loadChat(chatId);
                
                // Update active state
                chatItems.forEach(ci => ci.classList.remove('active'));
                this.classList.add('active');
            });
        });
        
        // Show/hide PDF upload section based on RAG toggle
        const ragCheckbox = document.getElementById('use-rag');
        const pdfsSection = document.getElementById('uploaded-pdfs');
        
        pdfsSection.style.display = 'none';
        
        ragCheckbox.addEventListener('change', function() {
            if (this.checked) {
                // RAG enabled - show PDF upload section
                if (currentChatId) {
                    pdfsSection.style.display = 'block';
                }
            } else {
                // RAG disabled - hide PDF upload section
                pdfsSection.style.display = 'none';
            }
        });
        
        // Add search functionality
        const searchInput = document.getElementById('chat-search');
        console.log('Search input found:', searchInput);
        if (searchInput) {
            console.log('Adding search event listener');
            searchInput.addEventListener('input', function() {
                console.log('Search input changed:', this.value);
                searchChats(this.value);
            });
            
            // Also add keyup event as backup
            searchInput.addEventListener('keyup', function() {
                console.log('Search keyup:', this.value);
                searchChats(this.value);
            });
            
            // Add click handler for testing
            searchInput.addEventListener('click', function() {
                console.log('Search input clicked');
            });
        } else {
            console.log('Search input not found!');
        }
        
        // Test search function
        console.log('Testing search function...');
        searchChats('');
    });

</script>
{% endblock %}

